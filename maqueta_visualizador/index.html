<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion MySQL - Licoreria</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="bg-shape bg-shape-1"></div>
    <div class="bg-shape bg-shape-2"></div>

    <main class="app-shell">
      <header class="hero">
        <div>
          <p class="eyebrow">Base Productos</p>
          <h1>Gestion productos MySQL</h1>
          <p class="hero-copy">
            Administra productos, registra ventas diarias y controla movimientos de kardex sobre MySQL.
          </p>
          <p id="appVersionLabel" class="hero-version">Version -</p>
        </div>
        <button id="reloadBtn" class="btn" type="button">Recargar</button>
      </header>

      <div id="appMessage" class="message app-message" aria-live="polite"></div>

      <section id="dbStatusCard" class="db-status-card" aria-live="polite">
        <span id="dbStatusDot" class="db-status-dot is-idle" aria-hidden="true"></span>
        <div class="db-status-content">
          <p class="db-status-label">Base de datos</p>
          <strong id="dbStatusText">Sin verificar</strong>
          <small id="dbStatusMeta">Pulsa "Reintentar" para validar conexiÃ³n.</small>
          <small id="dbStatusLastCheck">Ultima verificacion: -</small>
        </div>
        <div class="db-status-actions">
          <button id="dbStatusRefreshBtn" class="btn btn-ghost" type="button">Reintentar</button>
        </div>
      </section>

      <div class="mobile-nav-wrap">
        <button
          id="mobileNavToggle"
          class="btn btn-ghost mobile-nav-toggle"
          type="button"
          aria-controls="mainViewNav"
          aria-expanded="false"
        >
          Secciones
        </button>
      </div>

      <nav id="mainViewNav" class="view-nav" aria-label="Navegacion principal">
        <button
          id="navSales"
          class="view-nav-btn is-active"
          data-view="sales"
          type="button"
          aria-selected="true"
        >
          Ventas diarias
        </button>
        <button
          id="navProducts"
          class="view-nav-btn"
          data-view="products"
          type="button"
          aria-selected="false"
        >
          Gestion de productos
        </button>
        <button
          id="navKardex"
          class="view-nav-btn"
          data-view="kardex"
          type="button"
          aria-selected="false"
        >
          Kardex
        </button>
        <button
          id="navSettings"
          class="view-nav-btn"
          data-view="settings"
          type="button"
          aria-selected="false"
        >
          Settings
        </button>
      </nav>

      <div class="mobile-kpi-wrap">
        <button
          id="kpiToggleBtn"
          class="btn btn-ghost mobile-kpi-toggle"
          type="button"
          aria-controls="kpiCollapsible"
          aria-expanded="false"
        >
          Ver resumen rÃ¡pido
        </button>
      </div>

      <div id="kpiCollapsible" class="kpi-collapsible">
        <section class="kpi-grid">
          <article class="kpi">
            <p>Productos registrados</p>
            <strong id="kpiProducts">0</strong>
          </article>
          <article class="kpi">
            <p>Ventas en el rango seleccionado</p>
            <strong id="kpiSalesRangeAmount">S/ 0.00</strong>
          </article>
          <article class="kpi">
            <p>Cantidad de ventas en el rango seleccionado</p>
            <strong id="kpiSales">0</strong>
          </article>
          <article class="kpi">
            <p>Movimientos kardex en el rango seleccionado</p>
            <strong id="kpiKardex">0</strong>
          </article>
        </section>
      </div>

      <section class="panel" data-view-panel="products">
        <div class="panel-header panel-header-stack">
          <h2>Listado y edicion de productos</h2>
          <div class="table-toolbar">
            <label class="search-bar" for="crudSearch">
              <span class="search-icon" aria-hidden="true">âŒ•</span>
              <input id="crudSearch" type="search" placeholder="Buscar por NÂ°, nombre, categorÃ­a, precio o stock" />
            </label>
            <button id="openCreateBtn" class="btn" type="button">Crear producto</button>
          </div>
        </div>

        <div id="crudMessage" class="message" aria-live="polite"></div>

        <div class="table-wrap">
          <table id="productsTable">
            <thead>
              <tr>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="products" data-sort-key="NÂ°">
                    NÂ° <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="products" data-sort-key="NOMBRE">
                    NOMBRE <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="products" data-sort-key="CATEGORIA">
                    CATEGORIA <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="products" data-sort-key="PRECIO">
                    PRECIO <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="products" data-sort-key="PEDIDO">
                    PEDIDO <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="products" data-sort-key="STOCK_ACTUAL">
                    STOCK <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th>ACCIONES</th>
              </tr>
            </thead>
            <tbody id="crudBody"></tbody>
          </table>
        </div>

        <div class="pager">
          <div class="pager-nav">
            <button id="crudPrevBtn" class="pager-btn" type="button">Anterior</button>
            <button id="crudNextBtn" class="pager-btn" type="button">Siguiente</button>
          </div>
          <div class="pager-meta">
            <label>
              Filas
              <select id="crudPageSize">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="30">30</option>
                <option value="50">50</option>
              </select>
            </label>
            <span id="crudPageInfo">Pagina 1 de 1</span>
          </div>
        </div>
      </section>

      <section class="panel is-active" data-view-panel="sales">
        <div class="panel-header panel-header-stack">
          <div class="sales-main-tools">
            <div class="sales-quick-card">
              <div>
                <h2>Ventas diarias</h2>
                <p class="sales-quick-copy">Registra una venta en una ventana rÃ¡pida y mantÃ©n los filtros limpios.</p>
              </div>
              <div class="sales-quick-actions">
                <button id="openSaleDialogBtn" class="btn" type="button">Nueva venta rÃ¡pida</button>
                <button id="exportSalesCsvBtn" class="btn btn-ghost" type="button">Exportar Excel XML</button>
              </div>
            </div>
            <div class="sales-tools">
              <div class="sales-date-range">
                <label>
                  Desde
                  <input id="salesDateFrom" type="date" />
                </label>
                <label>
                  Hasta
                  <input id="salesDateTo" type="date" />
                </label>
                <button id="salesDateTodayBtn" class="btn btn-ghost sales-date-today" type="button">Hoy</button>
              </div>
              <label class="search-bar" for="salesSearch">
                <span class="search-icon" aria-hidden="true">âŒ•</span>
                <input id="salesSearch" type="search" placeholder="Buscar ventas por fecha, NÂ° o nombre" />
              </label>
            </div>
          </div>
        </div>

        <div id="saleMessage" class="message" aria-live="polite"></div>

        <div class="table-wrap">
          <table id="salesTable">
            <thead>
              <tr>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="sales" data-sort-key="FECHA">
                    FECHA <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="sales" data-sort-key="NÂ°">
                    NÂ° <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="sales" data-sort-key="NOMBRE">
                    NOMBRE <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="sales" data-sort-key="CANTIDAD">
                    CANTIDAD <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="sales" data-sort-key="PRECIO">
                    PRECIO <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="sales" data-sort-key="TOTAL">
                    TOTAL <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="sales" data-sort-key="TIPO_PAGO">
                    TIPO PAGO <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="sales" data-sort-key="ORIGEN">
                    ORIGEN <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th>ACCIONES</th>
              </tr>
            </thead>
            <tbody id="salesBody"></tbody>
          </table>
        </div>

        <div class="pager sales-pager">
          <div class="pager-nav">
            <button id="salesPrevBtn" class="pager-btn" type="button">Anterior</button>
            <button id="salesNextBtn" class="pager-btn" type="button">Siguiente</button>
          </div>
          <div class="pager-meta">
            <label>
              Filas
              <select id="salesPageSize">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="30">30</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </label>
            <span id="salesPageInfo">Pagina 1 de 1</span>
          </div>
        </div>
      </section>

      <section class="panel" data-view-panel="kardex">
        <div class="panel-header panel-header-stack">
          <h2>Kardex (desde ahora)</h2>
          <div class="table-toolbar table-toolbar-kardex">
            <label class="search-bar" for="kardexSearch">
              <span class="search-icon" aria-hidden="true">âŒ•</span>
              <input id="kardexSearch" type="search" placeholder="Buscar por NÂ°, nombre, referencia o nota" />
            </label>
            <select id="kardexTypeFilter" aria-label="Filtrar tipo kardex">
              <option value="TODOS">Todos</option>
              <option value="INGRESO">Ingreso</option>
              <option value="SALIDA">Salida</option>
            </select>
          </div>
        </div>

        <div class="table-wrap">
          <table id="kardexTable">
            <thead>
              <tr>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="kardex" data-sort-key="FECHA_HORA">
                    FECHA/HORA <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="kardex" data-sort-key="NÂ°">
                    NÂ° <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="kardex" data-sort-key="NOMBRE">
                    NOMBRE <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="kardex" data-sort-key="TIPO">
                    TIPO <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="kardex" data-sort-key="CANTIDAD">
                    CANTIDAD <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="kardex" data-sort-key="STOCK_ANTES">
                    ANTES <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="kardex" data-sort-key="STOCK_DESPUES">
                    DESPUES <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
                <th class="sort-head">
                  <button class="sort-btn" type="button" data-sort-table="kardex" data-sort-key="REFERENCIA">
                    REFERENCIA <span class="sort-indicator" aria-hidden="true">â†•</span>
                  </button>
                </th>
              </tr>
            </thead>
            <tbody id="kardexBody"></tbody>
          </table>
        </div>
      </section>

      <section class="panel" data-view-panel="settings">
        <div class="panel-header panel-header-stack">
          <h2>Settings de conexion</h2>
          <p class="settings-copy">
            Define la URL base del servidor donde vive la API MySQL.
          </p>
        </div>

        <form id="apiSettingsForm" class="settings-form">
          <label class="full-row" for="apiBaseUrlInput">
            URL servidor API
            <input
              id="apiBaseUrlInput"
              type="text"
              inputmode="url"
              placeholder="https://api.escon.pe"
              autocomplete="off"
            />
          </label>
          <div class="settings-actions">
            <button id="saveApiBaseBtn" class="btn" type="submit">Guardar servidor</button>
            <button id="useCurrentOriginBtn" class="btn btn-ghost" type="button">
              Usar URL de esta pestaÃ±a
            </button>
            <button id="testApiBaseBtn" class="btn btn-alt" type="button">Probar conexion</button>
            <button id="testCpanelDbBtn" class="btn btn-alt" type="button">Probar DB cPanel</button>
          </div>
        </form>

        <p class="settings-current">
          Activo:
          <code id="apiBaseUrlCurrent">-</code>
        </p>
        <div class="settings-access-card">
          <p class="settings-access-title">Access Host para cPanel (MySQL remoto)</p>
          <p class="settings-access-copy">
            Este host lo autorizas en cPanel &gt; Remote MySQL para permitir la conexiÃ³n.
          </p>
          <div class="settings-access-row">
            <input
              id="accessHostValue"
              type="text"
              readonly
              value="-"
              aria-label="Access host detectado para cPanel"
            />
            <button id="copyAccessHostBtn" class="btn btn-ghost settings-access-copy-btn" type="button">
              <span aria-hidden="true">ðŸ“‹</span>
              Copiar
            </button>
            <button id="refreshAccessHostBtn" class="btn btn-alt" type="button">Detectar host</button>
          </div>
          <small id="accessHostMeta" class="settings-access-meta">
            Pulsa "Detectar host" para obtener el valor que debes autorizar en cPanel.
          </small>
        </div>
        <div class="settings-probe-card">
          <div class="settings-probe-head">
            <p class="settings-probe-title">Respuesta de prueba backend</p>
            <span id="cpanelProbeBadge" class="settings-probe-badge is-idle">Sin probar</span>
          </div>
          <small id="cpanelProbeMeta" class="settings-probe-meta">
            Pulsa "Probar DB cPanel" para ver la respuesta real de /api/db/status.
          </small>
          <pre id="cpanelProbeBody" class="settings-probe-body">-</pre>
        </div>
        <div id="settingsMessage" class="message" aria-live="polite"></div>
      </section>
    </main>

    <dialog id="saleDialog" class="sale-dialog">
      <div class="dialog-head">
        <h3 id="saleDialogTitle">Registrar venta diaria</h3>
        <button id="saleDialogCloseBtn" class="dialog-close" type="button" aria-label="Cerrar">Ã—</button>
      </div>

      <form id="saleForm" class="sale-form sale-dialog-form">
        <label class="full-row sale-product-field">
          Producto
          <div class="sale-product-picker">
            <input
              id="saleProductLookup"
              type="search"
              placeholder="Busca por cÃ³digo o nombre"
              autocomplete="off"
              required
            />
            <button
              id="saleProductClearBtn"
              class="sale-product-clear"
              type="button"
              aria-label="Limpiar bÃºsqueda de producto"
            >
              Ã—
            </button>
          </div>
          <div id="saleProductDropdown" class="sale-product-dropdown" role="listbox" hidden></div>
          <small class="sale-product-hint">Escribe cÃ³digo o parte del nombre y toca para seleccionar.</small>
          <input id="saleProductId" type="hidden" />
        </label>
        <label>
          Cantidad
          <div class="sale-qty-control">
            <button id="saleQtyDownBtn" class="sale-qty-step" type="button" aria-label="Disminuir cantidad">-</button>
            <input id="saleCantidad" type="number" min="1" step="1" required value="1" />
            <button id="saleQtyUpBtn" class="sale-qty-step" type="button" aria-label="Aumentar cantidad">+</button>
          </div>
        </label>
        <label>
          Precio unitario
          <input id="salePrecioPreview" class="sale-preview-field" type="text" readonly value="-" />
        </label>
        <label>
          Total estimado
          <input id="saleTotalPreview" class="sale-preview-field" type="text" readonly value="-" />
        </label>
        <label>
          Fecha
          <input id="saleFecha" type="date" required />
        </label>
        <label>
          Tipo de pago
          <select id="saleTipoPago" required>
            <option value="Efectivo" selected>Efectivo</option>
            <option value="A Ya Per">A Ya Per</option>
            <option value="Pedido Ya">Pedido Ya</option>
            <option value="Rappi">Rappi</option>
            <option value="EasyPay">EasyPay</option>
          </select>
        </label>
        <label class="full-row">
          Nota
          <input id="saleNota" type="text" maxlength="120" placeholder="Opcional" />
        </label>
        <div class="sale-actions full-row">
          <button id="saleSubmitBtn" class="btn" type="submit">Confirmar venta</button>
          <button id="saleCancelBtn" class="btn btn-alt" type="button">Cancelar</button>
        </div>
        <section id="saleConfirmBox" class="sale-confirm-box full-row" hidden>
          <h4 id="saleConfirmTitle">Confirmar venta</h4>
          <div class="sale-confirm-grid">
            <p><span>Producto</span><strong id="saleConfirmProduct">-</strong></p>
            <p><span>Cantidad</span><strong id="saleConfirmCantidad">-</strong></p>
            <p><span>Fecha</span><strong id="saleConfirmFecha">-</strong></p>
            <p><span>Tipo de pago</span><strong id="saleConfirmTipoPago">-</strong></p>
            <p><span>Total</span><strong id="saleConfirmTotal">-</strong></p>
          </div>
          <div class="sale-confirm-actions">
            <button id="saleConfirmBackBtn" class="btn btn-ghost" type="button">Volver a editar</button>
            <button id="saleConfirmSubmitBtn" class="btn" type="button">Guardar venta</button>
          </div>
        </section>
      </form>
    </dialog>

    <dialog id="productDialog" class="product-dialog">
      <div class="dialog-head">
        <h3 id="productDialogTitle">Crear producto</h3>
        <button id="dialogCloseBtn" class="dialog-close" type="button" aria-label="Cerrar">Ã—</button>
      </div>

      <form id="productForm" class="crud-form dialog-form">
        <input id="crudEditId" type="hidden" />
        <label>
          NÂ°
          <input id="crudId" type="number" min="1" step="1" placeholder="Automatico si lo dejas vacio" />
        </label>
        <label>
          NOMBRE
          <input id="crudNombre" type="text" required maxlength="120" placeholder="Nombre del producto" />
        </label>
        <label>
          PRECIO
          <input id="crudPrecio" type="number" min="0" step="0.01" required placeholder="0.00" />
        </label>
        <label>
          PEDIDO
          <input id="crudPedido" type="number" min="0" step="1" value="0" />
        </label>
        <label>
          STOCK ACTUAL
          <input id="crudStockActual" type="number" min="0" step="0.01" value="0" />
        </label>
        <label>
          AJUSTE STOCK (+/-)
          <input id="crudStockAjuste" type="number" step="0.01" value="0" />
        </label>
        <label class="full-row">
          Nota movimiento
          <input id="crudNota" type="text" maxlength="120" placeholder="Opcional para kardex" />
        </label>
        <div class="crud-actions">
          <button id="crudSaveBtn" class="btn" type="submit">Guardar producto</button>
          <button id="crudCancelBtn" class="btn btn-alt" type="button">Cancelar</button>
        </div>
      </form>
    </dialog>

    <dialog id="ingressDialog" class="ingress-dialog">
      <div class="dialog-head">
        <h3>Ingreso de stock</h3>
        <button id="ingressDialogCloseBtn" class="dialog-close" type="button" aria-label="Cerrar">Ã—</button>
      </div>

      <form id="ingressForm" class="crud-form dialog-form ingress-form">
        <input id="ingressProductId" type="hidden" />
        <label class="full-row">
          Producto
          <input id="ingressProductLabel" type="text" readonly />
        </label>
        <label>
          Stock actual
          <input id="ingressCurrentStock" type="text" readonly />
        </label>
        <label>
          Cantidad a ingresar
          <input id="ingressCantidad" type="number" min="1" step="1" required value="1" />
        </label>
        <label class="full-row">
          Nota movimiento
          <input id="ingressNota" type="text" maxlength="120" placeholder="Opcional para kardex" />
        </label>
        <div id="ingressMessage" class="message full-row" aria-live="polite"></div>
        <div class="crud-actions">
          <button id="ingressSubmitBtn" class="btn" type="submit">Confirmar ingreso</button>
          <button id="ingressCancelBtn" class="btn btn-alt" type="button">Cancelar</button>
        </div>
      </form>
    </dialog>

    <script src="./custom-functions.js"></script>
    <script src="./components/product-table.component.js"></script>
    <script src="./components/sales-table.component.js"></script>
    <script src="./components/kardex-table.component.js"></script>
    <script src="./pages/products-page.js"></script>
    <script src="./pages/sales-page.js"></script>
    <script src="./pages/kardex-page.js"></script>
    <script src="./pages/settings-page.js"></script>
    <script src="./app.js"></script>
  </body>
</html>
